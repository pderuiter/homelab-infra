---
# VACUUM ANALYZE CronJob - runs daily
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-vacuum-analyze
  namespace: databases
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: maintenance
spec:
  # Daily at 4:00 AM UTC (after backup completes)
  schedule: "0 4 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgres
            app.kubernetes.io/component: maintenance
        spec:
          restartPolicy: Never
          serviceAccountName: default
          containers:
            - name: vacuum-analyze
              image: ghcr.io/cloudnative-pg/postgresql:16.4
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  echo "Starting VACUUM ANALYZE on all databases..."

                  # Get superuser credentials
                  export PGPASSWORD=$(cat /secrets/password)
                  PGUSER=$(cat /secrets/username)
                  PGHOST="postgres-cluster-rw.databases.svc.cluster.local"

                  # List all databases except templates
                  DATABASES=$(psql -h $PGHOST -U $PGUSER -d postgres -t -c "SELECT datname FROM pg_database WHERE datistemplate = false AND datname != 'postgres';")

                  for DB in $DATABASES; do
                    DB=$(echo $DB | xargs)  # Trim whitespace
                    if [ -n "$DB" ]; then
                      echo "Running VACUUM ANALYZE on database: $DB"
                      psql -h $PGHOST -U $PGUSER -d "$DB" -c "VACUUM (VERBOSE, ANALYZE);" || echo "Warning: VACUUM ANALYZE failed for $DB"
                    fi
                  done

                  echo "VACUUM ANALYZE completed!"
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
              volumeMounts:
                - name: superuser-credentials
                  mountPath: /secrets
                  readOnly: true
          volumes:
            - name: superuser-credentials
              secret:
                secretName: postgres-superuser-credentials
---
# REINDEX CronJob - runs weekly
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-reindex
  namespace: databases
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: maintenance
spec:
  # Weekly on Sunday at 5:00 AM UTC
  schedule: "0 5 * * 0"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgres
            app.kubernetes.io/component: maintenance
        spec:
          restartPolicy: Never
          serviceAccountName: default
          containers:
            - name: reindex
              image: ghcr.io/cloudnative-pg/postgresql:16.4
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  echo "Starting REINDEX on all databases..."

                  export PGPASSWORD=$(cat /secrets/password)
                  PGUSER=$(cat /secrets/username)
                  PGHOST="postgres-cluster-rw.databases.svc.cluster.local"

                  DATABASES=$(psql -h $PGHOST -U $PGUSER -d postgres -t -c "SELECT datname FROM pg_database WHERE datistemplate = false AND datname != 'postgres';")

                  for DB in $DATABASES; do
                    DB=$(echo $DB | xargs)
                    if [ -n "$DB" ]; then
                      echo "Running REINDEX on database: $DB"
                      psql -h $PGHOST -U $PGUSER -d "$DB" -c "REINDEX DATABASE \"$DB\";" || echo "Warning: REINDEX failed for $DB"
                    fi
                  done

                  echo "REINDEX completed!"
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
              volumeMounts:
                - name: superuser-credentials
                  mountPath: /secrets
                  readOnly: true
          volumes:
            - name: superuser-credentials
              secret:
                secretName: postgres-superuser-credentials
---
# pg_stat_statements reset - monthly
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-stats-reset
  namespace: databases
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: maintenance
spec:
  # Monthly on 1st at 6:00 AM UTC
  schedule: "0 6 1 * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgres
            app.kubernetes.io/component: maintenance
        spec:
          restartPolicy: Never
          serviceAccountName: default
          containers:
            - name: stats-reset
              image: ghcr.io/cloudnative-pg/postgresql:16.4
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  echo "Resetting pg_stat_statements..."

                  export PGPASSWORD=$(cat /secrets/password)
                  PGUSER=$(cat /secrets/username)
                  PGHOST="postgres-cluster-rw.databases.svc.cluster.local"

                  psql -h $PGHOST -U $PGUSER -d postgres -c "SELECT pg_stat_statements_reset();" || echo "Warning: pg_stat_statements_reset failed"

                  echo "Stats reset completed!"
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
              volumeMounts:
                - name: superuser-credentials
                  mountPath: /secrets
                  readOnly: true
          volumes:
            - name: superuser-credentials
              secret:
                secretName: postgres-superuser-credentials
